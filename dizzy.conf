# Nginx site config for dizzyScript
#
# Usage (Debian/Ubuntu):
#   sudo cp /path/to/repo/dizzy.conf /etc/nginx/sites-available/dizzy.conf
#   sudo ln -s /etc/nginx/sites-available/dizzy.conf /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx
#
# Edit the following values to match your server:
# - server_name
# - root (path to your htdocs for this project)
# - php_fpm upstream (socket or host:port)


# Preserve HTTPS info if behind a proxy (Cloudflare / Load Balancer)
map $http_x_forwarded_proto $fastcgi_https {
    default off;
    https on;
}

server {
    listen 7888;
    server_name localhost;  # CHANGE ME

    # Path to your project root (htdocs)
    root /Applications/MAMP/htdocs;  # CHANGE ME: absolute path to the repo's htdocs
    index index.php index.html index.htm;

    # Friendly error pages
    # Note: Let the PHP router render 404/403 pages to avoid Nginx recursion
    # If you want Nginx to serve a static page instead, point to an actual file like /404.html
    # error_page 404 /404.html;
    # error_page 403 /403.html;

    # Gzip (equivalent to mod_deflate rules)
    gzip on;
    gzip_vary on;
    gzip_types
        text/plain text/css text/javascript application/javascript application/x-javascript
        application/json application/xml application/rss+xml application/xhtml+xml
        image/svg+xml image/x-icon font/ttf font/otf application/vnd.ms-fontobject;

    # Security headers (equivalent to mod_headers)
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
    # add_header Content-Security-Policy "default-src 'self' data: blob:; img-src 'self' data: blob: *; media-src 'self' data: blob: *; frame-ancestors 'self'" always; # optional

    # Deny access to hidden files (.git, .env, etc.)
    location ~ /\. {
        deny all;
    }

    # Front controller: serve static if exists, otherwise route to index.php
    location / {
        # Use $is_args$args to preserve query string only when present
        try_files $uri $uri/ /index.php$is_args$args;
        # Pretty URLs: falls back to index.php while preserving query string
    }

    # Cache headers similar to Apache mod_expires
    location ~* \.(?:css|js)$ {
        expires 7d;
        add_header Cache-Control "public";
    }
    location ~* \.(?:jpg|jpeg|gif|png|svg|ico)$ {
        expires 30d;
        add_header Cache-Control "public";
    }
    location ~* \.(?:pdf)$ {
        expires 30d;
        add_header Cache-Control "public";
    }

    # Deny direct PHP execution in sensitive folders (mirrors .htaccess)
    location ~ ^/(themes|includes|sources|langs|src)/.*\.(?:php|phtml|php[0-9]?|phps)$ {
        deny all;
        return 403;
    }

    # Allow AJAX/endpoint PHP files under /requests
    location ~ ^/requests/.*\.php$ {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        # Preserve original URI and HTTPS/proxy details
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param HTTPS $fastcgi_https;
        # Pass Authorization header through to PHP (Bearer/Basic tokens)
        fastcgi_param HTTP_AUTHORIZATION $http_authorization;
        # Use MAMP's PHP-FPM socket
        fastcgi_pass unix:/Applications/MAMP/Library/logs/fastcgi/nginxFastCGI.sock;
    }

    # Generic PHP handler (supports /index.php/anything PATH_INFO)
    location ~ \.php(?:$|/) {
        # Only pass existing scripts to PHP; avoid treating /index.php/foo as a real path
        try_files $fastcgi_script_name =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;

        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO       $fastcgi_path_info;
        fastcgi_param REQUEST_URI     $request_uri;
        fastcgi_param HTTPS           $fastcgi_https;
        fastcgi_param HTTP_AUTHORIZATION $http_authorization;

        # Use MAMP's PHP-FPM socket
        fastcgi_pass unix:/Applications/MAMP/Library/logs/fastcgi/nginxFastCGI.sock;

        fastcgi_intercept_errors off;
    }

    # Optional: handle service worker explicitly
    location = /sw.js { try_files $uri =404; }

    # Optional: increase upload size if needed
    client_max_body_size 128m;
}
