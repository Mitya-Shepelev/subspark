version: '3.8'

services:
  # SubSpark Application (PHP-FPM + Nginx)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: subspark-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8000}:80"
    environment:
      # Database - используем существующий MySQL контейнер
      # ВАЖНО: укажите имя вашего MySQL контейнера в DB_SERVER
      DB_SERVER: ${DB_SERVER:-mysql-8}
      DB_USERNAME: ${DB_USERNAME:-subspark_user}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE:-subspark}

      # Application
      APP_ENV: ${APP_ENV:-production}
      APP_URL: ${APP_URL:-http://localhost:8000}

      # S3 Storage (optional)
      S3_STATUS: ${S3_STATUS:-0}
      S3_BUCKET: ${S3_BUCKET:-}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_KEY: ${S3_KEY:-}
      S3_SECRET: ${S3_SECRET:-}
      S3_PUBLIC_BASE: ${S3_PUBLIC_BASE:-}

      # Wasabi (optional)
      WASABI_STATUS: ${WASABI_STATUS:-0}
      WASABI_BUCKET: ${WASABI_BUCKET:-}
      WASABI_REGION: ${WASABI_REGION:-us-east-1}
      WASABI_KEY: ${WASABI_KEY:-}
      WASABI_SECRET: ${WASABI_SECRET:-}

      # DigitalOcean Spaces (optional)
      SPACES_STATUS: ${SPACES_STATUS:-0}
      SPACES_NAME: ${SPACES_NAME:-}
      SPACES_REGION: ${SPACES_REGION:-nyc3}
      SPACES_KEY: ${SPACES_KEY:-}
      SPACES_SECRET: ${SPACES_SECRET:-}

      # MinIO (optional)
      MINIO_STATUS: ${MINIO_STATUS:-0}
      MINIO_BUCKET: ${MINIO_BUCKET:-}
      MINIO_REGION: ${MINIO_REGION:-us-east-1}
      MINIO_KEY: ${MINIO_KEY:-}
      MINIO_SECRET: ${MINIO_SECRET:-}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-}
      MINIO_PUBLIC_BASE: ${MINIO_PUBLIC_BASE:-}

    volumes:
      # Persistent storage for user uploads
      - uploads_data:/var/www/html/uploads

    networks:
      # Подключаемся к существующей сети MySQL
      - mysql-8_default
      # Подключаемся к Nginx Proxy Manager для доступа через домен
      - nginx-proxy-manager_default

    labels:
      # Labels для Nginx Proxy Manager (опционально)
      - "com.nginx-proxy-manager.enabled=true"
      # Uncomment and configure if using NPM:
      # - "traefik.enable=true"
      # - "traefik.http.routers.subspark.rule=Host(`your-domain.com`)"
      # - "traefik.http.services.subspark.loadbalancer.server.port=80"

    healthcheck:
      test: ["CMD", "php-fpm", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  # Хранилище для пользовательских загрузок
  uploads_data:
    driver: local

networks:
  # Используем существующие внешние сети
  mysql-8_default:
    external: true
  nginx-proxy-manager_default:
    external: true
